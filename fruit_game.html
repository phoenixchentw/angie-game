<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°ä¼éµèˆ‡å¥½æœ‹å‹</title>
    <style>
        :root { --sky: #D1E9F6; --text: #546E7A; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; overflow: hidden; background: var(--sky); font-family: sans-serif; width: 100%; height: 100%; position: fixed; }
        #game-wrapper { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; cursor: pointer; }

        .home-btn {
            position: absolute; top: 15px; right: 15px; width: 44px; height: 44px;
            background: rgba(255, 255, 255, 0.4); border: 2px solid #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: var(--text); font-size: 24px; text-decoration: none;
            z-index: 10000; backdrop-filter: blur(5px);
        }

        #hud { position: absolute; top: 20px; left: 20px; color: var(--text); z-index: 5000; pointer-events: none; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 8000; flex-direction: column; }
        .btn-real { background: #81C784; color: white; border: 3px solid white; padding: 18px 50px; font-size: 24px; border-radius: 60px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 0 #66BB6A; outline: none; }
        .result-modal { background: white; padding: 30px; border-radius: 25px; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="game-wrapper">
    <a href="index.html" class="home-btn">ğŸ </a>
    <div id="hud">
        <div style="font-size: 20px; font-weight: bold;">æˆ‘å€‘å¾—çš„åˆ†æ•¸: <span id="score-text">0</span> / 100</div>
    </div>
    <canvas id="gameCanvas"></canvas>

    <div id="start-mask" class="overlay">
        <h1 style="color:var(--text); margin-bottom:10px;">ğŸ§ ä¼éµèˆ‡å¥½æœ‹å‹</h1>
        <p style="color:#78909C; margin-bottom:30px; text-align:center;">
            ç§»å‹•æ»‘é¼ æˆ–æ‰‹æŒ‡ï¼Œå…©ä½å¥½æœ‹å‹ä¸€èµ·æ¥æ°´æœï¼<br>
            æ°´æœæ‰åˆ°åœ°ä¸Šæœƒæ‰£ 5 åˆ†å–”ï¼
        </p>
        <button class="btn-real" id="start-btn">é–‹å§‹éŠæˆ²ï¼</button>
    </div>

    <div id="result-modal" class="overlay" style="display:none;">
        <div class="result-modal">
            <h2 id="result-title" style="color:var(--text);">æŒ‘æˆ°å®Œæˆï¼</h2>
            <p id="final-score" style="color:#FF8A80; font-size:28px; font-weight:bold; margin:15px 0;"></p>
            <button class="btn-real" style="font-size:18px; padding:12px 30px;" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
            <a href="index.html" style="text-decoration:none; color:#90A4AE; font-weight:bold; display:block; margin-top:20px;">å›åˆ°å¤§å»³</a>
        </div>
    </div>
</div>

<script>
// ä½¿ç”¨ var ä»¥ç¢ºä¿æœ€é«˜ç€è¦½å™¨ç›¸å®¹æ€§
var canvas = document.getElementById('gameCanvas');
var ctx = canvas.getContext('2d');
var score = 0;
var isGaming = false;

var friends = ['ğŸ§', 'ğŸ»'];
var playerX = 0; 
var items = [];
var floatingTexts = [];
var spawnTimer = 0;

function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    playerX = canvas.width / 2;
}

// ç¹ªè£½æ£®æ—èƒŒæ™¯
function drawBackground() {
    ctx.globalAlpha = 1.0;
    // 1. å¤©ç©º
    var skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    skyGradient.addColorStop(0, "#D1E9F6");
    skyGradient.addColorStop(1, "#FFFFFF");
    ctx.fillStyle = skyGradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 2. é è™•çš„å±±
    ctx.fillStyle = "#CFD8DC";
    drawMountain(canvas.width * 0.3, canvas.height * 0.8, 350, 220);
    ctx.fillStyle = "#B0BEC5";
    drawMountain(canvas.width * 0.7, canvas.height * 0.8, 450, 280);

    // 3. è‰åœ°
    ctx.fillStyle = "#A1C398";
    ctx.fillRect(0, canvas.height * 0.8, canvas.width, canvas.height * 0.2);
}

function drawMountain(x, y, w, h) {
    ctx.beginPath();
    ctx.moveTo(x - w/2, y);
    ctx.lineTo(x, y - h);
    ctx.lineTo(x + w/2, y);
    ctx.fill();
}

// ç‰©å“ç”Ÿæˆé‚è¼¯
function handleSpawning() {
    spawnTimer++;
    // æ¯éš”ç´„ 0.5~1ç§’ ç”Ÿæˆä¸€å€‹ç‰©é«”ï¼Œéš¨åˆ†æ•¸è®Šå¿«
    var interval = Math.max(30, 70 - Math.floor(score / 4));
    if (spawnTimer >= interval) {
        var isBomb = Math.random() < 0.15;
        items.push({
            x: Math.random() * (canvas.width - 60) + 30,
            y: -50,
            char: isBomb ? 'ğŸ’£' : ['ğŸ', 'ğŸŠ', 'ğŸ‡', 'ğŸ‘', 'ğŸ“'][Math.floor(Math.random()*5)],
            isBomb: isBomb,
            speed: (Math.random() * 1.5 + 3) * (1 + (score / 100))
        });
        spawnTimer = 0;
    }
}

function update() {
    if (!isGaming) return;
    
    handleSpawning();

    for (var i = items.length - 1; i >= 0; i--) {
        items[i].y += items[i].speed;
        
        var hitZoneWidth = 140; // å…©ä½æœ‹å‹çš„æ¥çƒç¸½å¯¬åº¦
        var startX = playerX - (hitZoneWidth / 2);
        var endX = playerX + (hitZoneWidth / 2);
        
        // 1. æˆåŠŸæ¥ä½åˆ¤å®š
        if (items[i].y > canvas.height - 140 && items[i].y < canvas.height - 80) {
            if (items[i].x > startX && items[i].x < endX) {
                if (items[i].isBomb) {
                    score = Math.max(0, score - 10);
                    popText(items[i].x, items[i].y, "-10", "#90A4AE");
                } else {
                    score += 5;
                    popText(items[i].x, items[i].y, "+5", "#FFB74D");
                }
                updateScoreDisplay();
                items.splice(i, 1);
                if (score >= 100) victory();
                continue;
            }
        }

        // 2. è½åœ°åˆ¤å®š
        if (items[i].y > canvas.height - 20) {
            if (!items[i].isBomb) {
                score = Math.max(0, score - 5);
                popText(items[i].x, canvas.height - 50, "-5 (æ¼æ‰å•¦!)", "#E57373");
                updateScoreDisplay();
            }
            items.splice(i, 1);
        }
    }
    
    // ç‰¹æ•ˆæ–‡å­—æ›´æ–°
    for (var j = 0; j < floatingTexts.length; j++) {
        floatingTexts[j].y -= 1.2;
        floatingTexts[j].life -= 0.015;
    }
    floatingTexts = floatingTexts.filter(function(f) { return f.life > 0; });
}

function updateScoreDisplay() {
    document.getElementById('score-text').innerText = score;
}

function draw() {
    // æ¯ä¸€å¹€é–‹å§‹éƒ½è¦å¼·åˆ¶é‡ç½®é€æ˜åº¦ï¼Œè§£æ±ºã€ŒåŠé€æ˜ã€å•é¡Œ
    ctx.globalAlpha = 1.0;
    
    drawBackground();
    
    // ç•«å¥½æœ‹å‹ (ä¼éµèˆ‡å°ç†Š)
    ctx.font = "60px Arial";
    ctx.textAlign = "center";
    var startPos = playerX - 40;
    friends.forEach(function(f, idx) {
        var x = startPos + (idx * 80);
        var y = canvas.height - 100;
        
        // è§’è‰²å½±å­
        ctx.fillStyle = "rgba(0,0,0,0.1)";
        ctx.beginPath(); ctx.ellipse(x, y + 20, 30, 10, 0, 0, 7); ctx.fill();
        
        // è§’è‰²èˆ‡ç±ƒå­
        ctx.fillStyle = "black";
        ctx.fillText(f, x, y);
        ctx.font = "40px Arial";
        ctx.fillText("ğŸ§º", x, y - 50);
        ctx.font = "60px Arial";
    });

    // ç•«æ‰è½æ°´æœ
    ctx.font = "45px Arial";
    items.forEach(function(it) {
        ctx.fillText(it.char, it.x, it.y);
    });

    // ç•«æ¼‚æµ®ç‰¹æ•ˆæ–‡å­—
    floatingTexts.forEach(function(ft) {
        ctx.globalAlpha = ft.life;
        ctx.fillStyle = ft.color;
        ctx.font = "bold 20px Arial";
        ctx.fillText(ft.text, ft.x, ft.y);
    });
    
    ctx.globalAlpha = 1.0; // çµæŸå‰å†æ¬¡é‡ç½®

    if (isGaming) {
        update();
        requestAnimationFrame(draw);
    }
}

function popText(x, y, txt, col) {
    var fullText = txt + " (ç¸½åˆ†: " + score + ")";
    floatingTexts.push({ x: x, y: y, text: fullText, color: col, life: 1 });
}

function move(ev) {
    var x = ev.touches ? ev.touches[0].clientX : ev.clientX;
    playerX = x;
    // é‚Šç•Œä¿è­·ï¼Œä¸è®“æœ‹å‹è·‘å‡ºè¢å¹•
    if (playerX < 80) playerX = 80;
    if (playerX > canvas.width - 80) playerX = canvas.width - 80;
}

function startGame() {
    document.getElementById('start-mask').style.display = 'none';
    isGaming = true;
    score = 0;
    items = [];
    floatingTexts = [];
    updateScoreDisplay();
    init();
    requestAnimationFrame(draw);
}

function victory() {
    isGaming = false;
    document.getElementById('final-score').innerText = "å¤§å®¶åˆä½œæ‹¿åˆ° 100 åˆ†ï¼";
    document.getElementById('result-modal').style.display = 'flex';
    try { localStorage.setItem('fruit_score', 100); } catch(err){}
}

// ç›£è½å™¨
var startBtn = document.getElementById('start-btn');
startBtn.addEventListener('click', startGame);
startBtn.addEventListener('pointerdown', startGame);

window.addEventListener('pointermove', move);
window.addEventListener('touchmove', function(e){ e.preventDefault(); move(e); }, {passive:false});
window.addEventListener('resize', init);

// é å…ˆæ ¡æº–
init();
</script>
</body>
</html>